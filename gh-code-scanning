#!/usr/bin/env python

import argparse
import os
import shutil
import subprocess
import tempfile

def enable(args):
    branch_name = 'gh-code-scanning_{}/setup'.format(os.getpid())

    for nwo in args.repos:
        with tempfile.TemporaryDirectory('gh_code_scanning') as temp_dir:
            command = [args.gh, 'repo', 'clone', nwo, temp_dir, '--', '--depth=1']
            if not args.verbose:
                command.append('--quiet')
            subprocess.run(command)
            
            os.chdir(temp_dir)
            
            command = [args.git, 'checkout', '-b', branch_name]
            if not args.verbose:
                command.append('--quiet')
            subprocess.run(command)

            try:
                os.mkdir('.github')
                os.mkdir('.github/workflows')
            except FileExistsError as e:
                pass

            shutil.copy(os.path.join(os.path.dirname(__file__), 'codeql-analysis.yml'), '.github/workflows')
            
            command = [args.git, 'add', '--all']
            subprocess.run(command)
            
            command = [args.git, 'commit', '--message', 'Create .github/workflows/codeql-analysis.yml']
            if not args.verbose:
                command.append('--quiet')
            subprocess.run(command)
            
            command = [args.git, 'push', '--set-upstream', 'origin', branch_name]
            if not args.verbose:
                command.append('--quiet')
            subprocess.run(command)
            
            command = [args.gh, 'pr', 'create', '--fill', '--head', branch_name]
            subprocess.run(command)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--gh', default=shutil.which('gh'))
    parser.add_argument('--git', default=shutil.which('git'))
    parser.add_argument('-v', '--verbose', action='store_true')
    subparsers = parser.add_subparsers()
    
    parser_enable = subparsers.add_parser('enable', help='Set up Code Scanning with GitHub CodeQL')
    parser_enable.add_argument('-F', '--file', nargs=1)
    parser_enable.add_argument('-f', '--force', action='store_true')
    parser_enable.add_argument('repos', nargs='+')
    parser_enable.set_defaults(func=enable)
    
    args = parser.parse_args()
    print(args)
    args.func(args)

if __name__ == '__main__':
    main()
